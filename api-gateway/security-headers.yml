# Security Headers Configuration for Kong API Gateway
_format_version: "3.0"

# Enhanced Security Plugins
plugins:
  # Content Security Policy (CSP)
  - name: response-transformer
    config:
      add:
        headers:
          # Content Security Policy - Comprehensive protection against XSS
          - "Content-Security-Policy:default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; connect-src 'self' https://api.eagle.fusionx.com.br wss://api.eagle.fusionx.com.br https://keycloak.eagle.fusionx.com.br; media-src 'self'; object-src 'none'; child-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests"
          
          # Prevent MIME type sniffing
          - "X-Content-Type-Options:nosniff"
          
          # Prevent clickjacking attacks
          - "X-Frame-Options:DENY"
          
          # Enable XSS protection
          - "X-XSS-Protection:1; mode=block"
          
          # Control referrer information
          - "Referrer-Policy:strict-origin-when-cross-origin"
          
          # Feature Policy / Permissions Policy
          - "Permissions-Policy:geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"
          
          # Expect-CT header for certificate transparency
          - "Expect-CT:max-age=86400, enforce"
          
          # Custom security headers
          - "X-API-Security-Version:v1.2024"
          - "X-Content-Security-Policy:default-src 'self'"
          
      remove:
        headers:
          # Remove server information leakage
          - "Server"
          - "X-Powered-By"
          - "X-AspNet-Version"
          - "X-AspNetMvc-Version"
          - "X-Runtime"
          
  # HTTP Strict Transport Security (HSTS)
  - name: response-transformer
    config:
      add:
        headers:
          # Force HTTPS for 1 year, include subdomains, allow preloading
          - "Strict-Transport-Security:max-age=31536000; includeSubDomains; preload"
      
  # Request validation and sanitization
  - name: request-validator
    config:
      version: draft4
      # Validate request headers
      header_schema: |
        {
          "type": "object",
          "properties": {
            "content-type": {
              "type": "string",
              "enum": ["application/json", "application/x-www-form-urlencoded", "multipart/form-data"]
            },
            "user-agent": {
              "type": "string",
              "minLength": 1,
              "maxLength": 500
            }
          }
        }
      # Validate request parameters
      parameter_schema: |
        {
          "type": "object",
          "properties": {
            "page": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000
            },
            "limit": {
              "type": "integer", 
              "minimum": 1,
              "maximum": 100
            }
          }
        }
        
  # Advanced bot detection
  - name: bot-detection
    config:
      allow: []
      deny:
        - "curl"
        - "wget" 
        - "python-requests"
        - "postman"
        - "insomnia"
        - "httpie"
        - "apache-httpclient"
        - "okhttp"
        - "go-http-client"
        - "node-fetch"
        - "axios"
        - "scrapy"
        - "selenium"
        - "phantomjs"
        - "headlesschrome"
        
  # Request size limiting with detailed configuration
  - name: request-size-limiting
    config:
      allowed_payload_size: 10  # 10MB max
      size_unit: megabytes
      require_content_length: true
      
  # Advanced rate limiting with multiple policies
  - name: rate-limiting-advanced
    config:
      limit:
        - 1000  # requests per minute
        - 10000 # requests per hour  
        - 100000 # requests per day
      window_size:
        - 60    # 1 minute
        - 3600  # 1 hour
        - 86400 # 1 day
      identifier: consumer
      sync_rate: 10
      strategy: redis
      redis:
        host: redis-master
        port: 6379
        database: 2
        timeout: 2000
      hide_client_headers: false
      fault_tolerant: true
      
  # IP restriction with whitelist/blacklist
  - name: ip-restriction
    config:
      # Allow internal networks and specific IPs
      allow:
        - "10.0.0.0/8"      # Internal network
        - "172.16.0.0/12"   # Docker networks
        - "192.168.0.0/16"  # Local networks
        - "127.0.0.1/32"    # Localhost
      # Deny known malicious IPs (can be updated dynamically)
      deny: []
      message: "Access denied from your IP address"
      
  # Request/Response correlation and tracing
  - name: correlation-id
    config:
      header_name: "X-Request-ID"
      generator: uuid#counter
      echo_downstream: true
      
  # Advanced logging for security monitoring
  - name: http-log
    config:
      http_endpoint: "http://ms-orchestrator:8088/api/v1/security/audit"
      method: POST
      content_type: "application/json"
      timeout: 10000
      keepalive: 60000
      flush_timeout: 2
      retry_count: 3
      queue_size: 1000
      headers:
        Authorization: "Bearer eagle-internal-token"
        X-Source: "kong-gateway"
        
  # Session security
  - name: session
    config:
      storage: redis
      redis:
        host: redis-master
        port: 6379
        database: 3
        ssl: false
        ssl_verify: false
        server_name: null
      cookie:
        name: "eagle-session"
        path: "/"
        domain: ".eagle.fusionx.com.br"
        same_site: "Strict"
        http_only: true
        secure: true
        max_age: 3600
        renew: 600
      logout_methods:
        - "POST"
        - "DELETE"
      logout_query_arg: "logout"
      logout_post_arg: "logout"
      
  # Request termination for emergency blocking
  - name: request-termination
    enabled: false  # Can be enabled dynamically for emergency blocking
    config:
      status_code: 503
      content_type: "application/json"
      body: |
        {
          "error": "Service temporarily unavailable",
          "code": "SERVICE_UNAVAILABLE", 
          "message": "The service is currently under maintenance. Please try again later.",
          "timestamp": "{{.timestamp}}",
          "request_id": "{{.request_id}}"
        }
      trigger: null
      
# Route-specific security configurations
routes:
  # High-security route for alert creation
  - name: alert-creation-secure
    service: ms-orchestrator
    paths: ["/api/v1/alerts/create"]
    methods: ["POST"]
    tags: ["high-security", "alert-creation"]
    
  # Medium-security route for status queries  
  - name: status-query-secure
    service: ms-orchestrator
    paths: ["/api/v1/alerts/status"]
    methods: ["GET"]
    tags: ["medium-security", "status"]

# Security-specific plugins per route
plugins:
  # Enhanced security for alert creation
  - name: request-validator
    route: alert-creation-secure
    config:
      version: draft4
      body_schema: |
        {
          "type": "object",
          "properties": {
            "customerDocument": {
              "type": "string",
              "pattern": "^[0-9]{11}$|^[0-9]{14}$",
              "description": "CPF (11 digits) or CNPJ (14 digits)"
            },
            "scopeStartDate": {
              "type": "string",
              "format": "date",
              "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
            },
            "scopeEndDate": {
              "type": "string",
              "format": "date", 
              "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
            },
            "requesterId": {
              "type": "string",
              "minLength": 1,
              "maxLength": 100
            },
            "metadata": {
              "type": "object",
              "additionalProperties": true
            }
          },
          "required": ["customerDocument", "scopeStartDate", "scopeEndDate"],
          "additionalProperties": false
        }
        
  # Stricter rate limiting for alert creation
  - name: rate-limiting
    route: alert-creation-secure
    config:
      minute: 50      # Lower limit for sensitive operations
      hour: 500
      day: 5000
      policy: redis
      redis_host: redis-master
      redis_port: 6379
      redis_database: 4
      fault_tolerant: true
      hide_client_headers: false
      
  # Request size limiting for alert creation
  - name: request-size-limiting
    route: alert-creation-secure
    config:
      allowed_payload_size: 1  # 1MB for alert creation
      size_unit: megabytes
      require_content_length: true