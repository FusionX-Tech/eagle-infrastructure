# Kong Declarative Configuration - Eagle Solo-Full Architecture
_format_version: "3.0"
_transform: true

# Services Configuration - Microservices
services:
  # Cases API Service
  - name: ms-cases-api
    url: http://ms-cases-api:8080
    tags: ["microservice", "cases", "api"]
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    retries: 3
    
  # Alerts API Service  
  - name: ms-alerts-api
    url: http://ms-alerts-api:8081
    tags: ["microservice", "alerts", "api"]
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    retries: 3
    
  # Reports API Service
  - name: ms-reports-api
    url: http://ms-reports-api:8082
    tags: ["microservice", "reports", "api"]
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    retries: 3
    
  # Customers API Service
  - name: ms-customers-api
    url: http://ms-customers-api:8083
    tags: ["microservice", "customers", "api"]
    connect_timeout: 30000
    write_timeout: 30000
    read_timeout: 30000
    retries: 3

# Routes Configuration
routes:
  # Cases API Routes
  - name: cases-api-route
    service: ms-cases-api
    paths: ["/api/v1/cases"]
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
    strip_path: false
    preserve_host: false
    tags: ["api", "cases"]
    
  # Alerts API Routes
  - name: alerts-api-route
    service: ms-alerts-api
    paths: ["/api/v1/alerts"]
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
    strip_path: false
    preserve_host: false
    tags: ["api", "alerts"]
    
  # Reports API Routes
  - name: reports-api-route
    service: ms-reports-api
    paths: ["/api/v1/reports"]
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
    strip_path: false
    preserve_host: false
    tags: ["api", "reports"]
    
  # Customers API Routes
  - name: customers-api-route
    service: ms-customers-api
    paths: ["/api/v1/customers"]
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
    strip_path: false
    preserve_host: false
    tags: ["api", "customers"]

# Global Plugins
plugins:
  # CORS Plugin - Global
  - name: cors
    config:
      origins:
        - "http://localhost:3001"
        - "http://localhost:5173"
        - "https://eagle.fusionx.pro"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-Auth-Token
        - X-Correlation-ID
      exposed_headers:
        - X-Auth-Token
        - X-Correlation-ID
      credentials: true
      max_age: 3600
      preflight_continue: false
    tags: ["security", "cors"]
    
  # Request ID Plugin - Global
  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid#counter
      echo_downstream: true
    tags: ["observability", "correlation"]
    
  # Rate Limiting Plugin - Global
  - name: rate-limiting
    config:
      minute: 1000
      hour: 10000
      policy: local
      fault_tolerant: true
      hide_client_headers: false
    tags: ["security", "rate-limiting"]
    
  # Security Headers Plugin - Global
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Content-Type-Options: nosniff"
          - "X-Frame-Options: DENY"
          - "X-XSS-Protection: 1; mode=block"
          - "Referrer-Policy: strict-origin-when-cross-origin"
          - "Content-Security-Policy: default-src 'self'"
    tags: ["security", "headers"]

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
    tags: ["security", "size-limiting"]

  # Prometheus Metrics
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
    tags: ["observability", "metrics"]