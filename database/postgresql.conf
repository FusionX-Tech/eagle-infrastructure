# =====================================================
# CONFIGURAÇÃO OTIMIZADA DO POSTGRESQL PARA ALERTAS
# =====================================================

# Configurações de Conexão e Autenticação
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# Configurações de Memória
shared_buffers = 512MB                    # 25% da RAM disponível
effective_cache_size = 1GB                # 75% da RAM disponível
work_mem = 4MB                           # Para operações de sort/hash
maintenance_work_mem = 128MB             # Para VACUUM, CREATE INDEX
temp_buffers = 8MB                       # Para tabelas temporárias

# Configurações de WAL (Write-Ahead Logging)
wal_level = replica                      # Para replicação
wal_buffers = 16MB                       # Buffer para WAL
checkpoint_completion_target = 0.9       # Distribuir checkpoints
max_wal_size = 2GB                       # Tamanho máximo do WAL
min_wal_size = 512MB                     # Tamanho mínimo do WAL
checkpoint_timeout = 15min               # Timeout para checkpoints

# Configurações de Replicação
max_wal_senders = 3                      # Máximo de senders para replicas
max_replication_slots = 3                # Slots de replicação
hot_standby = on                         # Permitir leitura em standby
hot_standby_feedback = on                # Feedback de standby

# Configurações de Archive
archive_mode = on                        # Habilitar arquivamento
archive_command = 'test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f'
archive_timeout = 300                    # Timeout para archive (5 min)

# Configurações de Performance
random_page_cost = 1.1                   # Para SSDs
seq_page_cost = 1.0                      # Custo sequencial
cpu_tuple_cost = 0.01                    # Custo de processamento
cpu_index_tuple_cost = 0.005             # Custo de índice
cpu_operator_cost = 0.0025               # Custo de operadores

# Configurações de Planner
default_statistics_target = 100          # Estatísticas detalhadas
constraint_exclusion = partition         # Otimização para partições
enable_partitionwise_join = on           # Joins otimizados para partições
enable_partitionwise_aggregate = on      # Agregações otimizadas

# Configurações de Autovacuum
autovacuum = on                          # Habilitar autovacuum
autovacuum_max_workers = 3               # Workers para autovacuum
autovacuum_naptime = 1min                # Intervalo entre execuções
autovacuum_vacuum_threshold = 50         # Threshold para vacuum
autovacuum_analyze_threshold = 50        # Threshold para analyze
autovacuum_vacuum_scale_factor = 0.2     # Fator de escala para vacuum
autovacuum_analyze_scale_factor = 0.1    # Fator de escala para analyze

# Configurações de Logging
logging_collector = on                   # Coletar logs
log_directory = 'pg_log'                 # Diretório de logs
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d                    # Rotacionar logs diariamente
log_rotation_size = 100MB                # Rotacionar por tamanho
log_min_duration_statement = 1000       # Log queries > 1s
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on                     # Log checkpoints
log_connections = on                     # Log conexões
log_disconnections = on                  # Log desconexões
log_lock_waits = on                      # Log esperas por locks
log_temp_files = 10MB                    # Log arquivos temp > 10MB

# Configurações de Locks
deadlock_timeout = 1s                    # Timeout para deadlock
lock_timeout = 30s                       # Timeout para locks
statement_timeout = 300s                 # Timeout para statements (5 min)

# Configurações de Background Writer
bgwriter_delay = 200ms                   # Delay do background writer
bgwriter_lru_maxpages = 100             # Páginas máximas por round
bgwriter_lru_multiplier = 2.0           # Multiplicador LRU

# Configurações Específicas para Partições
enable_partition_pruning = on            # Poda de partições
constraint_exclusion = partition         # Exclusão por constraints

# Configurações de Parallel Query
max_parallel_workers_per_gather = 2     # Workers paralelos por gather
max_parallel_workers = 4                # Workers paralelos totais
parallel_tuple_cost = 0.1               # Custo de tuple paralelo
parallel_setup_cost = 1000.0            # Custo de setup paralelo

# Configurações de JIT (Just-In-Time Compilation)
jit = on                                 # Habilitar JIT
jit_above_cost = 100000                  # Custo mínimo para JIT
jit_inline_above_cost = 500000           # Custo para inlining
jit_optimize_above_cost = 500000         # Custo para otimização

# Configurações de Timezone
timezone = 'America/Sao_Paulo'
log_timezone = 'America/Sao_Paulo'

# Configurações de Locale
lc_messages = 'en_US.utf8'
lc_monetary = 'pt_BR.utf8'
lc_numeric = 'pt_BR.utf8'
lc_time = 'pt_BR.utf8'

# Configurações de Shared Preload Libraries
shared_preload_libraries = 'pg_stat_statements'

# Configurações de Extensões
pg_stat_statements.max = 10000           # Máximo de statements rastreados
pg_stat_statements.track = all           # Rastrear todos os statements